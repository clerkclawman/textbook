<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox House</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    /* ==================== */
    /* ROOT VARIABLES & BASE */
    /* ==================== */
    :root {
        --primary: #4361ee;
        --primary-light: #5a7cff;
        --secondary: #3f37c9;
        --accent: #4895ef;
        --light: #f8f9fa;
        --dark: #212529;
        --success: #4cc9f0;
        --warning: #f72585;
        --info: #7209b7;
        --text: #2b2d42;
        --text-light: #4a4d6b;
        --bg: #f8f9fa;
        --card-bg: #ffffff;
        --dark-bg: #1a1a2e;
        --dark-card: #16213e;
        --dark-text: #e6e6e6;
        --dark-text-light: #b8b8b8;
        --border-radius: 12px;
        --box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        --transition: all 0.3s ease;

        /* Layout */
        --container-padding: 60px 40px;
        --container-padding-mobile: 30px 20px;

        /* Typography */
        --header-size: 2.2rem;
        --header-size-large: 5rem;
        --font-size-small: 0.9rem;

        /* Buttons */
        --btn-padding: 15px 20px;
        --btn-font-size: 1rem;

        /* Forms */
        --select-padding: 25px 30px;
        --select-font-size: 2rem;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
    }

    body {
        background-color: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        width: 100vw;
        padding: 20px;
        font-size: 16px;
        transition: var(--transition);
        line-height: 1.6;
        /* Emergency visibility fix - ensure content is always visible */
        min-height: 100vh;
    }

    body.dark-mode {
        background-color: var(--dark-bg);
        color: var(--dark-text);
    }


    /* ============== */
    /* MAIN CONTAINER */
    /* ============== */
    .container {
        width: 95%;
        max-width: 1200px;
        text-align: center;
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 60px 40px;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
        font-size: 1.2rem;
    }

    body.dark-mode .container {
        background-color: var(--dark-card);
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    /* Main container specific styles */
    #mainContainer.container {
        width: 95%;
        max-width: 1200px;
        padding: var(--container-padding);
        font-size: 1.2rem;
        /* Failsafe visibility */
        background-color: var(--card-bg);
        color: var(--text);
    }

    #mainContainer .header {
        font-size: 4rem;
        margin-bottom: 50px;
        /* Failsafe visibility */
        color: var(--primary) !important;
    }


    /* ============ */
    /* TYPOGRAPHY */
    /* ============ */
    .header {
        font-size: var(--header-size);
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 30px;
        text-align: center;
        letter-spacing: -0.5px;
    }

    body.dark-mode .header {
        color: var(--accent);
    }

    .language-label {
        font-size: 1.2rem;
        margin-bottom: 5px;
        color: var(--primary);
        font-weight: bold;
    }

    body.dark-mode .language-label {
        color: var(--accent);
    }


    /* ============ */
    /* FORM ELEMENTS */
    /* ============ */
    .controls-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 25px;
        gap: 20px;
    }

    #mainContainer .controls-row {
        display: flex;
        flex-direction: column;
        margin-bottom: 25px;
        gap: 30px;
    }

    .dropdown {
        flex: 1;
        min-width: 0;
        position: relative;
    }

    select {
        width: 100%;
        padding: 15px 20px;
        font-size: 1rem;
        border-radius: var(--border-radius);
        border: 2px solid var(--primary);
        background-color: var(--card-bg);
        color: var(--text);
        cursor: pointer;
        appearance: none;
        transition: var(--transition);
    }

    #mainContainer select {
        padding: 25px 30px;
        font-size: 1.8rem;
        border-width: 3px;
    }

    select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    body.dark-mode select {
        background-color: var(--dark-card);
        color: var(--dark-text);
        border-color: var(--accent);
    }

    .dropdown:after {
        content: "‚ñº";
        font-size: 0.8rem;
        color: var(--primary);
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

    #mainContainer .dropdown:after {
        font-size: 1.5rem;
        right: 30px;
    }

    body.dark-mode .dropdown:after {
        color: var(--accent);
    }


    /* ============ */
    /* BUTTONS */
    /* ============ */
    .btn {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 15px 20px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        flex: 1;
        min-width: 0;
        border: 2px solid transparent;
    }

    .btn:hover {
        background-color: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: var(--text-light);
    }

    body.dark-mode .btn:disabled {
        background-color: var(--dark-text-light);
    }

    body.dark-mode .btn {
        background-color: var(--accent);
    }

    body.dark-mode .btn:hover {
        background-color: var(--primary-light);
    }

    /* ==================== */
    /* TV OPTIMIZED STYLES   */
    /* ==================== */
    /* Enhanced focus indicators for remote navigation */
    button:focus,
    select:focus,
    .file-input-label:focus,
    [tabindex="0"]:focus {
        outline: 3px solid var(--accent);
        outline-offset: 3px;
        box-shadow: 0 0 0 4px rgba(72, 149, 239, 0.3);
    }

    /* TV-friendly larger touch targets (min 44px) */
    button,
    .file-input-label,
    select {
        min-height: 48px;
        min-width: 48px;
    }

    /* High contrast focus for TV */
    @media TV {
        button:focus,
        select:focus,
        [tabindex="0"]:focus {
            outline: 4px solid #ff6b6b;
            outline-offset: 4px;
        }

        .container {
            font-size: 1.4rem;
            padding: 40px 50px;
        }

        .btn {
            padding: 20px 30px;
            font-size: 1.2rem;
        }
    }

    .file-upload-row {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 20px;
    }

    .file-input-container {
        flex: 1;
        position: relative;
        min-width: 0;
    }

    .file-input-label {
        display: block;
        width: 100%;
        padding: 15px 20px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: var(--border-radius);
        background-color: var(--primary);
        color: white;
        cursor: pointer;
        text-align: center;
        transition: var(--transition);
        border: 2px solid transparent;
    }

    .file-input-label:hover {
        background-color: var(--primary-light);
        transform: translateY(-2px);
    }

    .file-input-label:active {
        transform: translateY(0);
    }

    body.dark-mode .file-input-label {
        background-color: var(--accent);
    }

    body.dark-mode .file-input-label:hover {
        background-color: var(--primary-light);
    }

    #fileNameDisplay {
        font-size: 0.9rem;
        margin-top: 10px;
        color: var(--text-light);
        text-align: center;
    }

    body.dark-mode #fileNameDisplay {
        color: var(--dark-text-light);
    }


    /* ============ */
    /* READING MODE */
    /* ============ */
    .reading-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: var(--card-bg);
        color: var(--text);
        z-index: 100;
        overflow: hidden;
        padding: 15px;
        box-sizing: border-box;
        transition: var(--transition);
    }

    body.dark-mode .reading-container {
        background-color: var(--dark-card);
        color: var(--dark-text);
    }

    .reading-header {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        align-items: center;
        position: relative;
    }

    .page-counter {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.9rem;
        color: var(--text-light);
        font-weight: 600;
    }

    body.dark-mode .page-counter {
        color: var(--dark-text-light);
    }

    .exit-reading {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 15px;
        background-color: var(--warning);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10;
    }

    .reading-content {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: calc(100% - 120px);
        padding: 0 20px;
        overflow: hidden;
        margin-bottom: 60px;
    }

    .sentence-row {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        padding: 10px 20px;
        width: 100%;
        overflow: hidden;
        min-height: 0;
        box-sizing: border-box;
        max-height: 50vh;
    }

    .sentence-row:first-child {
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    body.dark-mode .sentence-row:first-child {
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .sentence-row.full-height {
        flex: 1 1 100% !important;
        height: 100% !important;
        min-height: 100% !important;
        max-height: 100% !important;
    }

    .sentence-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        position: relative;
    }

    .play-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        min-width: 40px;
        border-radius: 50%;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-right: 10px;
    }

    .sentence-display {
        font-size: 5vw;
        line-height: 1.4;
        text-align: left;
        word-break: break-word;
        overflow: hidden;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 5px;
        box-sizing: border-box;
        white-space: normal;
        min-height: 0;
        flex: 1;
        max-height: 100%;
        text-overflow: ellipsis;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
    }

    .sentence-display.full-height {
        line-height: 1.2 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        text-align: center !important;
        padding: 20px !important;
    }

.reading-footer {
        display: flex;
        justify-content: center; /* Changed from space-between to center */
        padding: 10px;
        align-items: center;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        background-color: var(--card-bg);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        transition: background-color 0.3s;
        height: 60px;
        gap: 15px; /* Added spacing between the different groups */
        overflow-x: auto;
        white-space: nowrap;
    }

    .reading-footer::-webkit-scrollbar {
        display: none;
    }

    /* Add this NEW class to group the arrows */
    .nav-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    body.dark-mode .reading-footer {
        background-color: var(--dark-card);
        box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
    }

    .nav-btn {
        flex-shrink: 0;
        background-color: var(--primary);
        color: white;
        border: none;
        min-width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s;
        position: relative;
        z-index: 20;
        margin: 0 5px;
    }

    .nav-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }

    .nav-btn:active {
        transform: scale(0.98);
    }

    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .font-controls {
        display: flex;
        gap: 5px;
    }

    .font-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        min-width: 35px;
        height: 35px;
        border-radius: 50%;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .font-btn:hover {
        background-color: var(--primary-light);
        transform: scale(1.05);
    }

    body.dark-mode .font-btn {
        background-color: var(--accent);
    }

    body.dark-mode .font-btn:hover {
        background-color: var(--primary-light);
    }

    .display-toggle {
        display: flex;
        gap: 5px;
        margin: 0 10px;
    }

    .display-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        min-width: 40px;
        height: 35px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        padding: 0 5px;
    }

    .display-btn.active {
        background-color: var(--accent);
        transform: scale(1.05);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    body.dark-mode .display-btn {
        background-color: var(--secondary);
    }

    body.dark-mode .display-btn.active {
        background-color: var(--accent);
    }

    .fruit-toggle {
        background-color: var(--warning);
        color: white;
        border: 2px solid var(--warning);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: none;
        flex-shrink: 0;
        margin: 0 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .fruit-toggle.on {
        background-color: var(--warning);
        border-color: var(--success);
        box-shadow: 0 0 10px var(--success);
    }


    /* ============ */
    /* TRANSLATION POPUP */
    /* ============ */
    .translation-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 800px;
        background-color: var(--card-bg);
        color: var(--text);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 1000;
        padding: 30px;
        display: none;
        max-height: 90vh;
        overflow-y: auto;
        transition: background-color 0.3s, color 0.3s;
    }

    body.dark-mode .translation-popup {
        background-color: var(--dark-card);
        color: var(--dark-text);
    }

    .translation-popup.active {
        display: block;
    }

    .translation-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .translation-popup-close {
        background-color: var(--warning);
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .translation-content {
        margin-bottom: 15px;
    }

    .translation-original {
        font-size: 1.5rem;
        margin-bottom: 10px;
        padding: 10px;
        background-color: rgba(0,0,0,0.05);
        border-radius: 8px;
    }

    .translation-result {
        font-size: 1.5rem;
        padding: 10px;
        background-color: rgba(67, 97, 238, 0.1);
        border-radius: 8px;
    }

    .translation-tts {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
    }

    .translation-tts:hover {
        background-color: var(--secondary);
    }

    .translation-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 999;
        display: none;
    }

    .translation-overlay.active {
        display: block;
    }


    /* ============ */
    /* FRUIT GAME */
    /* ============ */
    .fruit-game-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 200;
    }

    .fruit-game {
        background-color: var(--card-bg);
        color: var(--text);
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        max-width: 800px;
        width: 90%;
        transition: var(--transition);
    }

    body.dark-mode .fruit-game {
        background-color: var(--dark-card);
        color: var(--dark-text);
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .fruit-reels {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }

    .fruit-reel {
        font-size: 8rem;
        width: 150px;
        height: 150px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: var(--transition);
    }

    body.dark-mode .fruit-reel {
        background-color: var(--dark-card);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .reel-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .fruit-name {
        font-size: 1.2rem;
        height: 30px;
        text-align: center;
        color: var(--primary);
        font-weight: bold;
        min-width: 100px;
    }


    /* ============ */
    /* UTILITY CLASSES */
    /* ============ */
    .night-mode-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: var(--dark);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: var(--transition);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .night-mode-toggle:hover {
        transform: scale(1.1);
    }

    body.dark-mode .night-mode-toggle {
        background-color: var(--light);
        color: var(--dark);
    }


    /* ============ */
    /* ANIMATIONS */
    /* ============ */
    @keyframes confetti-fall {
        0% {
            transform: translateY(-10px) rotate(0deg);
            opacity: 0.8;
        }
        100% {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
        }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }


    /* ============ */
    /* RESPONSIVE DESIGN */
    /* ============ */
@media (max-width: 800px) {
    .sentence-display {
        font-size: 32px; /* Removed !important */
    }

        .controls-row, .file-upload-row {
            flex-direction: column;
        }

        select, .btn, .file-input-label {
            font-size: 1.2rem;
            padding: 12px;
        }

        .header {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .fruit-reels {
            flex-wrap: wrap;
            gap: 10px;
        }

        .fruit-reel {
            font-size: 4rem;
            width: 90px;
            height: 90px;
        }

        .reel-container {
            margin-bottom: 15px;
        }
    }

@media (max-width: 768px) {
    .sentence-row {
        flex-direction: row;
        align-items: center;
        padding: 5px;
        min-height: 80px;
    }

    .play-btn {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
        margin-right: 8px;
    }

    .sentence-display {
        font-size: 1.5rem;
        padding: 5px;
        line-height: 1.4;
        min-height: 60px;
    }
}
    .font-btn {
        min-width: 40px;
        height: 40px;
        font-size: 1rem;
    }

    .reading-footer {
        padding: 10px 5px;
        gap: 5px;
    }

        .container {
            padding: 30px 20px;
            width: 100%;
        }

        .controls-row, .file-upload-row {
            flex-direction: column;
            gap: 15px;
        }

        .header {
            font-size: 1.8rem;
            margin-bottom: 25px;
        }

        select, .btn, .file-input-label {
            padding: 12px 15px;
            font-size: 0.9rem;
        }

        .night-mode-toggle {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }

        .translation-popup {
            width: 95%;
            padding: 15px;
            max-height: 80vh;
        }

        .translation-original, .translation-result {
            font-size: 1.2rem !important;
            padding: 10px !important;
        }

        .translation-popup-header h3 {
            font-size: 1.5rem !important;
        }

        .translation-tts {
            font-size: 1rem !important;
            padding: 10px 15px !important;
        }
    }

    @media (min-width: 1024px) {
        #mainContainer .header {
            font-size: 5rem;
            margin-bottom: 60px;
        }

        #mainContainer select {
            padding: 30px 35px;
            font-size: 2rem;
        }

        #mainContainer .dropdown:after {
            font-size: 2rem;
            right: 35px;
        }
    }

    @media (min-width: 1280px) {
        .nav-btn {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .reading-footer {
            height: 70px;
        }

        .reading-content {
            height: calc(100% - 130px);
            margin-bottom: 70px;
        }
    }

    @media (max-width: 480px) {
        #mainContainer .header {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        #mainContainer select {
            padding: 12px 15px;
            font-size: 1rem;
        }

        #mainContainer .dropdown:after {
            font-size: 0.8rem;
            right: 15px;
        }

        .reading-footer {
            height: 50px;
            padding: 5px;
        }

        .nav-btn {
            min-width: 35px;
            height: 35px;
            font-size: 0.9rem;
            margin: 0 3px;
        }

        .font-btn {
            min-width: 30px;
            height: 30px;
            font-size: 0.8rem;
        }

        .display-btn {
            min-width: 35px;
            height: 30px;
            font-size: 0.7rem;
        }

        .fruit-toggle {
            width: 30px;
            height: 30px;
            font-size: 1rem;
        }

        .reading-content {
            margin-bottom: 50px;
        }
    }
@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 15px rgba(247, 37, 133, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(247, 37, 133, 0);
    }
}

/* News button - moved from inline styles */
.news-button {
    display: inline-block;
    background-color: #f72585;
    color: white;
    padding: 15px 30px;
    margin: 20px 0;
    border-radius: 50px;
    font-weight: bold;
    font-size: 1.5rem;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(247, 37, 133, 0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
}

/* Fruit game result container */
#fruitResult {
    font-size: 2rem;
    min-height: 60px;
    margin: 20px 0;
}

/* Exit game button */
#exitFruitGame {
    margin-top: 20px;
    background-color: var(--warning);
}

</head>
<body>
    <button class="night-mode-toggle" id="nightModeToggle" aria-label="Toggle dark mode" role="switch" aria-checked="false">üåô</button>

<main class="container" id="mainContainer">
    <h1 class="header">CHATTERBOX HOUSE</h1>

    <nav aria-label="Main navigation">
        <a href="news.html" class="news-button">News</a>
    </nav>

    <form class="controls-row" role="form" aria-label="Content selection">
        <div class="dropdown">
            <select id="contentTypeSelector" aria-label="Select content type" required>
                <option value="">Content Type</option>
                <option value="vocab">üìö Vocabulary</option>
                <option value="story">üìñ Stories</option>
                <option value="qa">‚ùì Q & A</option>
            </select>
        </div>

        <div class="dropdown">
            <select id="classSelector" aria-label="Select class" disabled required>
                <option value="">Select Class</option>

                <optgroup label="Featured">
                    <option value="Adult">Adult</option>
                </optgroup>

                <optgroup label="EIKEN Junior">
                    <option value="Bronze">Bronze (Phonics)</option>
                    <option value="Silver">Silver (Patterns)</option>
                    <option value="Gold">Gold (Intro)</option>
                </optgroup>

                <optgroup label="EIKEN Foundation">
                    <option value="Eiken7">Eiken 7</option>
                    <option value="Eiken6">Eiken 6</option>
                    <option value="Eiken5">Eiken 5</option>
                    <option value="Eiken4">Eiken 4</option>
                    <option value="Eiken3">Eiken 3</option>
                </optgroup>

                <optgroup label="EIKEN Advanced">
                    <option value="EikenPre2">Eiken Pre-2</option>
                    <option value="EikenPre2Plus">Eiken Pre-2 Plus</option>
                    <option value="Eiken2">Eiken 2</option>
                    <option value="EikenPre1">Eiken Pre-1</option>
                    <option value="Eiken1">Eiken 1</option>
                </optgroup>

                <optgroup label="Vocabulary">
                    <option value="VocabEiken5">Eiken 5 Vocabulary</option>
                </optgroup>

                <optgroup label="Other">
                    <option value="Conversation">Conversation Practice</option>
                    <option value="HighSchool">High School (Legacy)</option>
                    <option value="C">C Class (Legacy)</option>
                    <option value="X">X Class (Legacy)</option>
                </optgroup>
            </select>
        </div>

        <div class="dropdown">
            <select id="storySelector" aria-label="Select story" disabled required>
                <option value="">Select Story</option>
            </select>
        </div>
    </form>
</main>

    <!-- READING MODE CONTAINER -->
    <article class="reading-container" id="readingModeContainer" style="display: none;" aria-live="polite">
<header class="reading-header">
    <div class="page-counter" aria-live="polite">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
    <button id="exitReading" class="exit-reading" aria-label="Exit reading mode">‚úï</button>
</header>

        <section class="reading-content" aria-label="Content display">
<div class="sentence-row">
    <div class="sentence-controls">
        <button id="playEnglish" class="play-btn" aria-label="Play English audio">‚ñ∂</button>
        <div id="englishSentence" class="sentence-display" lang="en" role="status"></div>
    </div>
</div>

<div class="sentence-row">
    <div class="sentence-controls">
        <button id="playJapanese" class="play-btn" aria-label="Play Japanese audio">‚ñ∂</button>
        <div id="japaneseSentence" class="sentence-display" lang="ja" role="status"></div>
    </div>
</div>

<nav class="reading-footer" aria-label="Reading controls">
    <div class="font-controls">
        <button id="decreaseFont" class="font-btn" aria-label="Decrease font size">A-</button>
        <button id="increaseFont" class="font-btn" aria-label="Increase font size">A+</button>
    </div>

    <div class="nav-group">
        <button id="prevSentence" class="nav-btn" aria-label="Previous sentence">‚Üê</button>
        <button id="nextSentence" class="nav-btn" aria-label="Next sentence">‚Üí</button>
    </div>

    <div class="display-toggle" role="group" aria-label="Display mode">
        <button id="displayEnglish" class="display-btn active" aria-pressed="true" aria-label="Display English only">EN</button>
        <button id="displayJapanese" class="display-btn" aria-pressed="false" aria-label="Display Japanese only">JP</button>
        <button id="displayBoth" class="display-btn" aria-pressed="false" aria-label="Display both English and Japanese">BOTH</button>
    </div>

    <button id="fruitToggle" class="fruit-toggle" aria-label="Toggle fruit game" aria-pressed="false">üé∞ Fruit Game OFF</button>
</nav>
    </section>

    <!-- Translation Popup -->
    <div class="translation-overlay" id="translationOverlay" role="dialog" aria-modal="true" aria-labelledby="translationTitle" hidden>
<div class="translation-popup" id="translationPopup">
    <header class="translation-popup-header">
        <h3 id="translationTitle">TRANSLATION</h3>
        <button class="translation-popup-close" id="closeTranslationPopup" aria-label="Close translation">‚úï</button>
    </header>
    <div class="translation-content">
        <div class="language-label" id="sourceLanguageLabel">English:</div>
        <div class="translation-original" id="translationOriginal" lang="en" role="presentation"></div>

        <div class="language-label" id="targetLanguageLabel">Japanese:</div>
        <div class="translation-result" id="translationResult" lang="ja" role="presentation"></div>

        <button class="translation-tts" id="translationTts" aria-label="Play translation audio">
            <span>üîä PLAY SOUND</span>
        </button>
    </div>
</div>
    </article>

    <!-- Load external scripts -->
<script src="content/adult/adult.js"></script>
<script src="content/extras/vocabulary.js"></script>
<script src="content/extras/vocab.js"></script>
<script src="content/beginners/x.js"></script>
<script src="content/beginners/c.js"></script>
<script src="QA5.js"></script>
<script src="content/eiken-junior/bronze.js"></script>
<script src="content/eiken-junior/silver.js"></script>
<script src="content/eiken-junior/gold.js"></script>
        <script src="content/eiken/eiken7.js"></script>
        <script src="content/eiken/eiken6.js"></script>
<script src="content/eiken/eiken5.js"></script>
<script src="content/eiken/eiken3.js"></script>
<script src="content/eiken/eiken3-questions.js"></script>
<script src="content/eiken/eiken4.js"></script>
<script src="content/eiken/eiken1.js"></script>
<script src="content/conversation/easyquestions.js"></script>
<script src="content/conversation/gettingtoknow.js"></script>
<script src="content/conversation/wouldyourather.js"></script>
<script src="content/eiken-pre/eiken-pre2.js"></script>
<script src="content/eiken-pre/eiken-pre2plus.js"></script>
<script src="content/eiken/eiken2.js"></script>
<script src="content/eiken-pre/eiken-pre1.js"></script>

<script>
    // ====================
    // DEBUG & LOGGER SETUP
    // ====================
    const DEBUG = true; // Temporarily enabled for debugging visibility issues

    // Conditional logger - only logs when DEBUG is true
    const logger = {
        log: (...args) => { if (DEBUG) console.log(...args); },
        warn: (...args) => { if (DEBUG) console.warn(...args); },
        error: (...args) => { if (DEBUG) console.error(...args); },
        debug: (...args) => { if (DEBUG) console.debug(...args); }
    };

    // ====================
    // GLOBAL VARIABLES
    // ====================
    let currentClass = null;
    let currentStory = null;
    let sentences = [];
    let currentSentenceIndex = 0;
    let fruitGameEnabled = false;
    let fruitGameActive = false;
    let shouldAdvanceAfterGame = false;
    let isNightMode = false;
    let currentFontSize = 5; // vw units by default
// At the top of your script where variables are declared
const minFontSize = 2; // vw/rem units
const maxFontSize = 8; // vw/rem units
    let displayMode = 'both'; // 'english', 'japanese', or 'both'
    let lessonsData = {};
    let selectedText = '';
    let translationLang = '';

    // DOM elements
    let mainContainer, readingModeContainer, englishSentence, japaneseSentence;
    let prevSentenceBtn, nextSentenceBtn, playEnglishBtn, playJapaneseBtn;
    let exitReadingBtn, fruitToggleBtn, classSelector, storySelector;
    let translationPopup, translationOverlay, closeTranslationPopup;
    let translationOriginal, translationResult, translationTts;

    // ====================
    // INITIALIZATION
    // ====================
    function initElements() {
        mainContainer = document.getElementById('mainContainer');
        readingModeContainer = document.getElementById('readingModeContainer');
        englishSentence = document.getElementById('englishSentence');
        japaneseSentence = document.getElementById('japaneseSentence');
        prevSentenceBtn = document.getElementById('prevSentence');
        nextSentenceBtn = document.getElementById('nextSentence');
        playEnglishBtn = document.getElementById('playEnglish');
        playJapaneseBtn = document.getElementById('playJapanese');
        exitReadingBtn = document.getElementById('exitReading');
        fruitToggleBtn = document.getElementById('fruitToggle');
        classSelector = document.getElementById('classSelector');
        storySelector = document.getElementById('storySelector');
        const nightModeToggle = document.getElementById('nightModeToggle');

        if (!englishSentence || !japaneseSentence) {
            logger.error('Critical elements not found');
            return false;
        }
        return true;
    }

    function init() {
        if (!initElements()) {
            alert('Failed to initialize page elements');
            return;
        }

        setupEventListeners();
        loadSavedPreferences();
        loadExternalData().then(() => {
            logger.log('All external data loaded');
            classSelector.focus();
        }).catch(error => {
            logger.error('Error loading external data:', error);
            alert('Error loading required data files. Please check the console for details.');
        });
    }

    function setupEventListeners() {
        // Content type, class and story selection
        const contentTypeSelector = document.getElementById('contentTypeSelector');
        if (contentTypeSelector) contentTypeSelector.addEventListener('change', handleContentTypeChange);
        if (classSelector) classSelector.addEventListener('change', handleClassSelect);
        storySelector.addEventListener('change', handleStorySelect);

        // Font controls
        document.getElementById('increaseFont').addEventListener('click', increaseFontSize);
        document.getElementById('decreaseFont').addEventListener('click', decreaseFontSize);

        // Display mode controls
        document.getElementById('displayEnglish').addEventListener('click', () => setDisplayMode('english'));
        document.getElementById('displayJapanese').addEventListener('click', () => setDisplayMode('japanese'));
        document.getElementById('displayBoth').addEventListener('click', () => setDisplayMode('both'));

        // Reading mode navigation
        prevSentenceBtn.addEventListener('click', showPreviousSentence);
        nextSentenceBtn.addEventListener('click', showNextSentence);
        playEnglishBtn.addEventListener('click', () => playSentence('english'));
        playJapaneseBtn.addEventListener('click', () => playSentence('japanese'));
        exitReadingBtn.addEventListener('click', exitReadingMode);
        fruitToggleBtn.addEventListener('click', toggleFruitGame);

        // Night mode toggle
        document.getElementById('nightModeToggle').addEventListener('click', toggleNightMode);

        // Keyboard navigation
        document.addEventListener('keydown', handleRemoteInput);

        // Initialize speech synthesis
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = function() {
                logger.log('Voices loaded');
            };

            if (window.speechSynthesis.getVoices().length === 0) {
                window.speechSynthesis.getVoices();
            }
        }
    }

    function loadSavedPreferences() {
        // Night mode
        const savedNightMode = localStorage.getItem('nightMode') === 'true';
        if (savedNightMode) {
            isNightMode = true;
            document.body.classList.add('dark-mode');
            document.getElementById('nightModeToggle').textContent = '‚òÄÔ∏è';
        }

        // Font size
        const savedFontSize = parseFloat(localStorage.getItem('fontSize'));
        if (savedFontSize && !isNaN(savedFontSize)) {
            currentFontSize = Math.max(minFontSize, Math.min(maxFontSize, savedFontSize));
        }

        // Display mode
        const savedDisplayMode = localStorage.getItem('displayMode');
        if (savedDisplayMode && ['english', 'japanese', 'both'].includes(savedDisplayMode)) {
            displayMode = savedDisplayMode;
        }

        // Fruit game state
        const savedFruitGameState = localStorage.getItem('fruitGameEnabled');
        fruitGameEnabled = savedFruitGameState === 'true';
        updateFruitButtonState();

        // Initialize button states
        document.getElementById('displayEnglish').classList.toggle('active', displayMode === 'english');
        document.getElementById('displayJapanese').classList.toggle('active', displayMode === 'japanese');
        document.getElementById('displayBoth').classList.toggle('active', displayMode === 'both');
    }

    // ====================
    // CLASS & STORY MANAGEMENT
    // ====================
    function handleClassSelect() {
        currentClass = this.value;
        storySelector.disabled = !currentClass;

        if (currentClass) {
            populateStorySelector(currentClass);
        } else {
            storySelector.innerHTML = '<option value="">Select Story</option>';
            storySelector.disabled = true;
        }
    }

    function handleStorySelect() {
        currentStory = this.value;
        if (currentStory) {
            enterReadingMode(currentClass);
        }
    }

    // Content Type mappings: type ‚Üí { classKey: displayName }
    const contentByType = {
        vocab: {
            'VocabEiken5': 'Eiken 5 Vocabulary'
        },
        story: {
            'Bronze': 'Bronze (Phonics)',
            'Silver': 'Silver (Patterns)',
            'Gold': 'Gold (Intro)',
            'X': 'X Class Stories',
            'C': 'C Class Stories',
            'Eiken7': 'Eiken 7',
            'Eiken6': 'Eiken 6',
            'Eiken5': 'Eiken 5',
            'Eiken4': 'Eiken 4',
            'Eiken3': 'Eiken 3',
            'EikenPre2': 'Eiken Pre-2',
            'EikenPre2Plus': 'Eiken Pre-2 Plus',
            'Eiken2': 'Eiken 2',
            'EikenPre1': 'Eiken Pre-1',
            'Eiken1': 'Eiken 1'
        },
        qa: {
            'Calendar': 'Calendar Questions',
            'ConversationQA': 'Conversation Practice',
            'Eiken7Questions': 'Eiken 7 Questions *',
            'Eiken6Questions': 'Eiken 6 Questions *',
            'Eiken5Questions': 'Eiken 5 Questions',
            'Eiken3Questions': 'Eiken 3 Questions',
            'Eiken2Questions': 'Eiken 2 Questions *',
            'Eiken1Questions': 'Eiken 1 Questions *',
            'EikenPre2Questions': 'Eiken Pre-2 Questions *',
            'EikenPre1Questions': 'Eiken Pre-1 Questions *'
        }
    };

    function handleContentTypeChange() {
        const contentType = this.value;
        classSelector.innerHTML = '<option value="">Select Class</option>';
        storySelector.innerHTML = '<option value="">Select</option>';
        storySelector.disabled = true;

        if (contentType && contentByType[contentType]) {
            Object.entries(contentByType[contentType]).forEach(([cls, label]) => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = label;
                classSelector.appendChild(option);
            });
            classSelector.disabled = false;
            classSelector.focus();
        }
    }

function populateStorySelector(cls) {
    storySelector.innerHTML = '<option value="">Select Story</option>';
    if (!lessonsData[cls]) return;

    // Add questions first if they exist (without numbering)
    if (lessonsData[cls].questions) {
        const option = document.createElement('option');
        option.value = 'questions';
        option.textContent = 'QA Questions';
        storySelector.appendChild(option);
    }

    // Add stories with clean numbering starting at 1
    if (lessonsData[cls].stories) {
        lessonsData[cls].stories.forEach((story, idx) => {
            const option = document.createElement('option');
            option.value = idx; // direct index into stories array
            // Strip any leading numbers/dots from title for clean display
            let cleanTitle = story.title.replace(/^\d+\.\s*/, '');
            option.textContent = `${idx + 1}. ${cleanTitle}`;
            storySelector.appendChild(option);
        });
    }

    storySelector.disabled = false;
    storySelector.focus();
}
    // ====================
    // READING MODE FUNCTIONS
    // ====================
    function enterReadingMode(cls) {
        if (mainContainer) mainContainer.style.display = 'none';
        if (readingModeContainer) readingModeContainer.style.display = 'flex';

        initTranslationEvents();
        loadTextContent(cls);
    }

    function exitReadingMode() {
        mainContainer.style.display = 'block';
        readingModeContainer.style.display = 'none';
        stopSpeech();

        setTimeout(() => {
            classSelector.focus();
        }, 100);
    }

function loadTextContent(cls) {
    logger.log('Loading content for:', cls, 'Story:', currentStory);

    if (!lessonsData[cls]) {
        logger.error('Class not found:', cls, 'Available classes:', Object.keys(lessonsData));
        alert(`Data not found for class ${cls}`);
        exitReadingMode();
        return;
    }

    let content;
    if (currentStory === 'questions') {
        content = lessonsData[cls].questions;
    } else {
        const storyIndex = parseInt(currentStory);
        if (isNaN(storyIndex)) {
            logger.error('Invalid story index:', currentStory);
            alert('Invalid story selection');
            exitReadingMode();
            return;
        }
        if (storyIndex < 0 || !lessonsData[cls].stories || !lessonsData[cls].stories[storyIndex]) {
            logger.error('Invalid story index:', storyIndex, 'for class:', cls);
            alert('Invalid story selection');
            exitReadingMode();
            return;
        }
        content = lessonsData[cls].stories[storyIndex].content;
    }

    if (!content) {
        logger.error('Content not found for story:', currentStory, 'in class:', cls);
        alert(`Content not found for selected story`);
        exitReadingMode();
        return;
    }

    sentences = parseStoryFile(content);
    if (sentences.length > 0) {
        currentSentenceIndex = 0;
        displayCurrentSentence();
        setTimeout(() => {
            applyDisplayMode();
            ensureTextVisibility();
        }, 100);
    } else {
        alert('No valid sentences found in this story');
        exitReadingMode();
    }
}

function parseStoryFile(text) {
    const content = text && typeof text === 'object' ? text.content : text || '';
    const lines = content.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0 && !line.startsWith('#'));

    const result = [];
    let currentEnglish = null;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        // More accurate language detection:
        // 1. If line starts with special characters/emojis, treat as English
        // 2. If line has more Japanese characters than English, treat as Japanese
        // 3. Otherwise treat as English
        const isEnglish = /^[‚Üíüï∞Ô∏èüìâüìäüõëüó£Ô∏èüåäüó≥Ô∏èüÜïü§ùüìâüìõüîçüí°‚öñÔ∏èü§∑üèõÔ∏èüîÑüíºüí∞‚è≥üëµüë¥üö´üó∫Ô∏èüö´üòîüìâ‚úåÔ∏èüåüüìàüíµüáØüáµüåèüßëü§ùüßëüåéüá∫üá∏üè≠üá™üá∫üõÇ‚úãüì±‚ö†Ô∏èüõíüíäüìâüë∑‚ù§Ô∏èüß†‚úäüß©üå™Ô∏èüåçü§≤üö¶üåü]/.test(line) ||
                         (countJapaneseChars(line) < countEnglishChars(line));

        if (isEnglish) {
            if (currentEnglish) {
                result.push({
                    english: currentEnglish,
                    japanese: "",
                    number: result.length + 1
                });
            }
            currentEnglish = line;
        } else {
            if (currentEnglish) {
                result.push({
                    english: currentEnglish,
                    japanese: line,
                    number: result.length + 1
                });
                currentEnglish = null;
            } else {
                result.push({
                    english: "",
                    japanese: line,
                    number: result.length + 1
                });
            }
        }
    }

    if (currentEnglish) {
        result.push({
            english: currentEnglish,
            japanese: "",
            number: result.length + 1
        });
    }

    return result;
}

// Helper functions for language detection
function countJapaneseChars(str) {
    // Count Japanese characters (hiragana, katakana, kanji)
    const japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\uFF65-\uFF9F]/g;
    const matches = str.match(japaneseRegex);
    return matches ? matches.length : 0;
}

function countEnglishChars(str) {
    // Count English letters
    const englishRegex = /[a-zA-Z]/g;
    const matches = str.match(englishRegex);
    return matches ? matches.length : 0;
}

    function displayCurrentSentence() {
        if (!readingModeContainer || readingModeContainer.style.display !== 'flex') {
            return;
        }

        englishSentence = document.getElementById('englishSentence');
        japaneseSentence = document.getElementById('japaneseSentence');
        if (!englishSentence || !japaneseSentence) {
            logger.error('Sentence display elements not found');
            return;
        }

        if (!sentences || sentences.length === 0) {
            englishSentence.textContent = "No sentences loaded";
            japaneseSentence.textContent = "";
            return;
        }

        const sentence = sentences[currentSentenceIndex];

        if (sentence.english) englishSentence.textContent = sentence.english;
        if (sentence.japanese) japaneseSentence.textContent = sentence.japanese;

        englishSentence.style.fontSize = '';
        japaneseSentence.style.fontSize = '';

        prevSentenceBtn.disabled = false;
        nextSentenceBtn.disabled = false;

        ensureTextVisibility();
        applyFontSize();
        applyDisplayMode();
        updatePageCounter();
    }

    function updatePageCounter() {
        if (!sentences || sentences.length === 0) return;

        const currentPageEl = document.getElementById('currentPage');
        const totalPagesEl = document.getElementById('totalPages');

        if (currentPageEl) currentPageEl.textContent = currentSentenceIndex + 1;
        if (totalPagesEl) totalPagesEl.textContent = sentences.length;
    }

    // ====================
    // TEXT DISPLAY & FORMATTING
    // ====================
    function setDisplayMode(mode) {
        displayMode = mode;
        localStorage.setItem('displayMode', mode);

        const displayEnglish = document.getElementById('displayEnglish');
        const displayJapanese = document.getElementById('displayJapanese');
        const displayBoth = document.getElementById('displayBoth');

        displayEnglish.classList.toggle('active', mode === 'english');
        displayEnglish.setAttribute('aria-pressed', mode === 'english');
        displayJapanese.classList.toggle('active', mode === 'japanese');
        displayJapanese.setAttribute('aria-pressed', mode === 'japanese');
        displayBoth.classList.toggle('active', mode === 'both');
        displayBoth.setAttribute('aria-pressed', mode === 'both');

        applyDisplayMode();

        setTimeout(() => {
            applyFontSize();
            ensureTextVisibility();
        }, 50);
    }

    function applyDisplayMode() {
        if (!readingModeContainer || readingModeContainer.style.display !== 'flex') {
            return;
        }

        const sentenceRows = document.querySelectorAll('.sentence-row');
        if (!sentenceRows || sentenceRows.length === 0) {
            logger.error('No sentence rows found');
            return;
        }

        if (sentenceRows.length === 0) {
            if (!sentences || sentences.length === 0) {
                logger.warn('No sentences loaded - cannot apply display mode');
                return;
            }

            if (typeof applyDisplayMode.waiting === 'undefined') {
                applyDisplayMode.waiting = true;
                setTimeout(() => {
                    applyDisplayMode.waiting = false;
                    applyDisplayMode();
                }, 300);
                return;
            }

            logger.error('Failed to find sentence rows after waiting');
            return;
        }

        applyDisplayMode.waiting = false;

        const englishRow = sentenceRows[0];
        const japaneseRow = sentenceRows[1] || sentenceRows[0];
        const englishDisplay = englishRow.querySelector('.sentence-display');
        const japaneseDisplay = japaneseRow.querySelector('.sentence-display');

        englishRow.classList.remove('full-height');
        japaneseRow.classList.remove('full-height');
        if (englishDisplay) englishDisplay.classList.remove('full-height');
        if (japaneseDisplay) japaneseDisplay.classList.remove('full-height');

        englishRow.style.display = 'flex';
        japaneseRow.style.display = 'flex';
        englishRow.style.flex = '1';
        japaneseRow.style.flex = '1';

        switch(displayMode) {
            case 'english':
                japaneseRow.style.display = 'none';
                englishRow.classList.add('full-height');
                if (englishDisplay) englishDisplay.classList.add('full-height');
                break;

            case 'japanese':
                englishRow.style.display = 'none';
                japaneseRow.classList.add('full-height');
                if (japaneseDisplay) japaneseDisplay.classList.add('full-height');
                break;

            case 'both':
                break;
        }

        ensureTextVisibility();
    }

function increaseFontSize() {
    if (currentFontSize < maxFontSize) {
        currentFontSize += (window.innerWidth <= 768 ? 0.2 : 0.5);
        applyFontSize();
    }
}

function decreaseFontSize() {
    if (currentFontSize > minFontSize) {
        currentFontSize -= (window.innerWidth <= 768 ? 0.2 : 0.5);
        applyFontSize();
    }
}

function applyFontSize() {
    const englishDisplay = document.getElementById('englishSentence');
    const japaneseDisplay = document.getElementById('japaneseSentence');

    // First completely reset any font size styles
    if (englishDisplay) {
        englishDisplay.style.fontSize = '';
        englishDisplay.style.removeProperty('font-size');
    }
    if (japaneseDisplay) {
        japaneseDisplay.style.fontSize = '';
        japaneseDisplay.style.removeProperty('font-size');
    }

    // Force reflow
    void englishDisplay?.offsetHeight;
    void japaneseDisplay?.offsetHeight;

    // Calculate size based on device
    let size;
    if (window.innerWidth <= 768) {
        // For mobile, use rem units that scale with root font size
        const baseSize = 1.5; // Default mobile size in rem
        const scaleFactor = currentFontSize / 5; // 5 is default vw size
        size = `${baseSize * scaleFactor}rem`;
    } else {
        // For desktop, use vw units
        size = `${currentFontSize}vw`;
    }

    // Apply the new size
    if (displayMode === 'english' && englishDisplay) {
        englishDisplay.style.fontSize = size;
    }
    else if (displayMode === 'japanese' && japaneseDisplay) {
        japaneseDisplay.style.fontSize = size;
    }
    else {
        if (englishDisplay) englishDisplay.style.fontSize = size;
        if (japaneseDisplay) japaneseDisplay.style.fontSize = size;
    }

    localStorage.setItem('fontSize', currentFontSize);
    ensureTextVisibility();
}

    function ensureTextVisibility() {
        const activeDisplays = [];

        if (displayMode === 'english' || displayMode === 'both') {
            const englishDisplay = document.getElementById('englishSentence');
            if (englishDisplay) activeDisplays.push(englishDisplay);
        }

        if (displayMode === 'japanese' || displayMode === 'both') {
            const japaneseDisplay = document.getElementById('japaneseSentence');
            if (japaneseDisplay) activeDisplays.push(japaneseDisplay);
        }

        activeDisplays.forEach(display => {
            display.style.fontSize = `${currentFontSize}vw`;

            if (display.scrollHeight > display.clientHeight || display.scrollWidth > display.clientWidth) {
                let fontSize = currentFontSize;
                while ((display.scrollHeight > display.clientHeight ||
                       display.scrollWidth > display.clientWidth) &&
                       fontSize > 2) {
                    fontSize -= 0.5;
                    display.style.fontSize = `${fontSize}vw`;
                    void display.offsetHeight;
                }
            }
        });
    }

    // ====================
    // NAVIGATION
    // ====================
    function showNextSentence() {
        stopSpeech();
        closeTranslationPopupHandler();

        if (sentences.length === 0 || fruitGameActive) return;

        const isLastPage = currentSentenceIndex >= sentences.length - 1;

        if (fruitGameEnabled) {
            shouldAdvanceAfterGame = true;
            showFruitGame();
            return;
        }

        if (isLastPage) {
            currentSentenceIndex = 0;
            displayCurrentSentence();
            return;
        }

        advanceToNextSentence();
    }

    function advanceToNextSentence() {
        if (currentSentenceIndex < sentences.length - 1) {
            currentSentenceIndex++;
        } else {
            currentSentenceIndex = 0;
        }

        displayCurrentSentence();
        updatePageCounter();
    }

    function showPreviousSentence() {
        stopSpeech();
        closeTranslationPopupHandler();

        if (sentences.length === 0) return;

        if (currentSentenceIndex > 0) {
            currentSentenceIndex--;
        } else {
            currentSentenceIndex = sentences.length - 1;
        }

        displayCurrentSentence();
        updatePageCounter();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // ====================
    // SPEECH SYNTHESIS
    // ====================
    function playSentence(type) {
        if (sentences.length === 0 || fruitGameActive) return;

        const sentence = sentences[currentSentenceIndex];
        let text = type === 'english' ? sentence.english : sentence.japanese;
        const lang = type === 'english' ? 'en-US' : 'ja-JP';

        const emojiRegex = /(\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu;
        text = text.replace(emojiRegex, '').trim();

        stopSpeech();
        speakSentence(text, lang);
    }

    function stopSpeech() {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }
    }

    function speakSentence(text, lang) {
        if (!('speechSynthesis' in window)) {
            logger.warn('Speech synthesis not supported');
            return;
        }

        stopSpeech();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;

        const speakWithVoice = () => {
            const voices = window.speechSynthesis.getVoices();
            let voice;

            if (lang === 'en-US') {
                voice = voices.find(v =>
                    v.lang === 'en-US' &&
                    v.name.includes('English')
                );

                if (!voice) {
                    voice = voices.find(v =>
                        v.lang.startsWith('en-')
                    );
                }
            } else if (lang === 'ja-JP') {
                voice = voices.find(v =>
                    v.lang === 'ja-JP' ||
                    v.lang.startsWith('ja')
                );
            }

            if (voice) {
                utterance.voice = voice;
                logger.log('Using voice:', voice.name, 'for language:', lang);
            } else {
                logger.warn('No specific voice found for', lang, 'using default');
            }

            utterance.onerror = function(event) {
                logger.error('SpeechSynthesis error:', event);
            };

            window.speechSynthesis.speak(utterance);
        };

        const voices = window.speechSynthesis.getVoices();
        if (voices.length === 0) {
            logger.log('Waiting for voices to load...');
            window.speechSynthesis.onvoiceschanged = speakWithVoice;
        } else {
            speakWithVoice();
        }
    }

    function listVoices() {
        const voices = window.speechSynthesis.getVoices();
        logger.log("Available voices:");
        voices.forEach(voice => {
            logger.log(`- ${voice.name} (${voice.lang}) ${voice.default ? '[DEFAULT]' : ''}`);
        });
    }

    // ====================
    // TRANSLATION SYSTEM
    // ====================
    function initTranslationElements() {
        translationPopup = document.getElementById('translationPopup');
        translationOverlay = document.getElementById('translationOverlay');
        closeTranslationPopup = document.getElementById('closeTranslationPopup');
        translationOriginal = document.getElementById('translationOriginal');
        translationResult = document.getElementById('translationResult');
        translationTts = document.getElementById('translationTts');

        if (!translationPopup || !translationOverlay || !closeTranslationPopup ||
            !translationOriginal || !translationResult || !translationTts) {
            logger.error('One or more translation elements not found');
            return false;
        }

        selectedText = '';
        translationLang = '';
        return true;
    }

    function initTranslationEvents() {
        if (!initTranslationElements()) return;

        englishSentence.addEventListener('click', handleEnglishClick);
        japaneseSentence.addEventListener('click', handleJapaneseClick);
        document.addEventListener('mouseup', handleTextSelection);
        closeTranslationPopup.addEventListener('click', closeTranslationPopupHandler);
        translationOverlay.addEventListener('click', closeTranslationPopupHandler);
        translationTts.addEventListener('click', () => {
            if (selectedText && translationLang) {
                speakSentence(selectedText, translationLang === 'en' ? 'en-US' : 'ja-JP');
            }
        });
    }

    function showTranslationPopup(text, lang) {
        const trimmedText = text.trim();
        if (!trimmedText || trimmedText.length < 1 || trimmedText.toLowerCase() === 'translate') {
            return;
        }

        closeTranslationPopupHandler();
        selectedText = trimmedText;
        translationLang = lang;

        const sourceLabel = document.getElementById('sourceLanguageLabel');
        const targetLabel = document.getElementById('targetLanguageLabel');

        if (lang === 'en') {
            sourceLabel.textContent = 'English:';
            targetLabel.textContent = 'Japanese:';
        } else {
            sourceLabel.textContent = 'Japanese:';
            targetLabel.textContent = 'English:';
        }

        try {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.className = 'highlighted-text';
                span.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                range.surroundContents(span);
            }
        } catch (e) {
            logger.error('Error highlighting text:', e);
        }

        translationOriginal.textContent = selectedText;
        translationResult.textContent = "Loading translation...";
        translationPopup.classList.add('active');
        translationOverlay.classList.add('active');

        fetchTranslation(selectedText, lang);

        const nextBtn = document.getElementById('nextSentence');
        const prevBtn = document.getElementById('prevSentence');

        const closeOnNav = () => {
            closeTranslationPopupHandler();
            nextBtn.removeEventListener('click', closeOnNav);
            prevBtn.removeEventListener('click', closeOnNav);
        };

        nextBtn.addEventListener('click', closeOnNav);
        prevBtn.addEventListener('click', closeOnNav);
    }

    function closeTranslationPopupHandler() {
        if (!translationPopup || !translationOverlay) return;

        translationPopup.classList.remove('active');
        translationOverlay.classList.remove('active');
        stopSpeech();
        translationOriginal.textContent = '';
        translationResult.textContent = '';

        if (window.getSelection) {
            window.getSelection().removeAllRanges();
        }

        document.querySelectorAll('.highlighted-text').forEach(el => {
            const parent = el.parentNode;
            while (el.firstChild) {
                parent.insertBefore(el.firstChild, el);
            }
            parent.removeChild(el);
            parent.normalize();
        });

        selectedText = '';
        translationLang = '';
    }

    // Translation API Endpoints (FREE)
    const translationApis = [
        {
            name: 'MyMemory (direct)',
            fetch: async (text, langPair) => {
                const encodedText = encodeURIComponent(text);
                const encodedLangPair = encodeURIComponent(langPair);
                const apiUrl = `https://api.mymemory.translated.net/get?q=${encodedText}&langpair=${encodedLangPair}`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('MyMemory: Network error');
                const data = await response.json();
                if (!data.responseData || !data.responseData.translatedText) {
                    throw new Error('MyMemory: No translation data');
                }
                logger.log('Translation successful with MyMemory');
                return data.responseData.translatedText;
            }
        },
        {
            name: 'LibreTranslate (argos)',
            fetch: async (text, langPair) => {
                const [sourceLang, targetLang] = langPair.split('|');
                const apiUrl = 'https://translate.argosopentech.com/translate';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        q: text,
                        source: sourceLang,
                        target: targetLang,
                        format: 'text'
                    })
                });
                if (!response.ok) throw new Error('LibreTranslate argos: Network error');
                const data = await response.json();
                if (!data.translatedText) throw new Error('LibreTranslate argos: No translation');
                logger.log('Translation successful with LibreTranslate (argos)');
                return data.translatedText;
            }
        },
        {
            name: 'LibreTranslate (de)',
            fetch: async (text, langPair) => {
                const [sourceLang, targetLang] = langPair.split('|');
                const apiUrl = 'https://libretranslate.de/translate';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        q: text,
                        source: sourceLang,
                        target: targetLang,
                        format: 'text'
                    })
                });
                if (!response.ok) throw new Error('LibreTranslate de: Network error');
                const data = await response.json();
                if (!data.translatedText) throw new Error('LibreTranslate de: No translation');
                logger.log('Translation successful with LibreTranslate (de)');
                return data.translatedText;
            }
        }
    ];

    async function fetchTranslation(text, lang) {
        const langPair = lang === 'en' ? 'en|ja' : 'ja|en';

        // Update status
        translationResult.textContent = "Loading translation...";

        // Try each API in order, with fallback
        for (const api of translationApis) {
            try {
                logger.log(`Trying ${api.name}...`);

                let translatedText = await api.fetch(text, langPair);

                // Clean the translation
                translatedText = translatedText
                    .replace(/[#*_~`^]/g, '')
                    .replace(/\{.*?\}/g, '')
                    .replace(/\[.*?\]/g, '')
                    .replace(/\(.*?\)/g, '')
                    .replace(/\d+/g, '')
                    .trim();

                if (!translatedText) {
                    throw new Error('Translation returned empty after cleaning');
                }

                logger.log(`Translation successful with ${api.name}`);
                translationResult.textContent = translatedText;
                return;

            } catch (error) {
                logger.error(`${api.name} failed:`, error.message);
                // Continue to next API
            }
        }

        // All APIs failed
        logger.error('All translation APIs failed');
        translationResult.textContent = "Unable to get translation";

        // Try local dictionary as last resort for short text
        if (text.length < 20) {
            trySimpleDictionaryLookup(text, lang);
        }
    }

    function trySimpleDictionaryLookup(text, lang) {
        const word = text.toLowerCase();
        const enToJaDict = {
            'shows': 'Áï™ÁµÑ',
            'show': 'Ë¶ã„Åõ„Çã',
            'hello': '„Åì„Çì„Å´„Å°„ÅØ',
            'goodbye': '„Åï„Çà„ÅÜ„Å™„Çâ',
            'thank you': '„ÅÇ„Çä„Åå„Å®„ÅÜ',
            'please': '„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô'
        };

        const jaToEnDict = {
            '„Åì„Çì„Å´„Å°„ÅØ': 'hello',
            '„ÅÇ„Çä„Åå„Å®„ÅÜ': 'thank you',
            '„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô': 'please',
            'Áï™ÁµÑ': 'show',
            'Ë¶ã„Åõ„Çã': 'show'
        };

        const dict = lang === 'en' ? enToJaDict : jaToEnDict;
        if (dict[word]) {
            translationResult.textContent = dict[word];
        } else {
            for (const [key, value] of Object.entries(dict)) {
                if (word.includes(key)) {
                    translationResult.textContent = value;
                    return;
                }
            }
            translationResult.textContent = "Translation not found";
        }
    }

    function handleTextSelection() {
        try {
            const selection = window.getSelection();
            if (!selection || selection.isCollapsed || selection.rangeCount === 0) {
                return;
            }

            const selectedText = selection.toString().trim();
            if (!selectedText || selectedText.length < 1 || selectedText.toLowerCase() === 'translate') {
                return;
            }

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;
            const isEnglish = englishSentence.contains(container);
            const isJapanese = japaneseSentence.contains(container);
            if (!isEnglish && !isJapanese) {
                closeTranslationPopupHandler();
                return;
            }

            if (range.collapsed) {
                closeTranslationPopupHandler();
                return;
            }

            showTranslationPopup(selectedText, isEnglish ? 'en' : 'ja');
        } catch (error) {
            logger.error('Error in text selection handling:', error);
        }
    }

    function handleEnglishClick(e) {
        if (e.target === englishSentence) {
            const word = getWordAtPoint(englishSentence, e.clientX, e.clientY);
            if (word) {
                showTranslationPopup(word, 'en');
            }
        }
    }

    function handleJapaneseClick(e) {
        if (e.target === japaneseSentence) {
            const word = getWordAtPoint(japaneseSentence, e.clientX, e.clientY);
            if (word) {
                showTranslationPopup(word, 'ja');
            }
        }
    }

    function getWordAtPoint(element, x, y) {
        const range = document.caretRangeFromPoint(x, y);
        if (!range) return null;

        range.expand('word');
        const word = range.toString().trim();
        return word || null;
    }

    // ====================
    // FRUIT GAME
    // ====================
const categories = [
        {
            name: 'Animals (Singular)',
            items: [
                {emoji: 'üê∂', name: 'a dog'},
                {emoji: 'üê±', name: 'a cat'},
                {emoji: 'üê≠', name: 'a mouse'},
                {emoji: 'üê∞', name: 'a rabbit'},
                {emoji: 'ü¶ä', name: 'a fox'},
                {emoji: 'üêª', name: 'a bear'},
                {emoji: 'üê∏', name: 'a frog'},
                {emoji: 'ü¶Å', name: 'a lion'},
                {emoji: 'üêÆ', name: 'a cow'},
                {emoji: 'üê¶', name: 'a bird'}
            ]
        },
        {
            name: 'Fruit & Food',
            items: [
                {emoji: 'üçé', name: 'an apple'},
                {emoji: 'üçä', name: 'an orange'},
                {emoji: 'üçå', name: 'a banana'},
                {emoji: 'ü•ö', name: 'an egg'},
                {emoji: 'üçà', name: 'a melon'},
                {emoji: 'üçë', name: 'a peach'},
                {emoji: 'üçî', name: 'a burger'},
                {emoji: 'ü•™', name: 'a sandwich'},
                {emoji: 'üå≠', name: 'a hot dog'},
                {emoji: 'üç©', name: 'a donut'}
            ]
        },
        {
            name: 'Action Verbs 1',
            items: [
                {emoji: 'üèÉ', name: 'run'},
                {emoji: 'üö∂', name: 'walk'},
                {emoji: 'üèä', name: 'swim'},
                {emoji: '‚úàÔ∏è', name: 'fly'},
                {emoji: 'üö¥', name: 'ride'},
                {emoji: 'üõë', name: 'stop'},
                {emoji: 'üíÉ', name: 'dance'},
                {emoji: 'ü§∏', name: 'jump'},
                {emoji: 'üßó', name: 'climb'},
                {emoji: 'üé£', name: 'fish'}
            ]
        },
        {
            name: 'Action Verbs 2',
            items: [
                {emoji: 'ü•£', name: 'eat'},
                {emoji: 'ü•õ', name: 'drink'},
                {emoji: 'üò¥', name: 'sleep'},
                {emoji: 'üìñ', name: 'read'},
                {emoji: '‚úçÔ∏è', name: 'write'},
                {emoji: 'üç≥', name: 'cook'},
                {emoji: 'üõÄ', name: 'wash'},
                {emoji: 'üõí', name: 'shop'},
                {emoji: 'üé§', name: 'sing'},
                {emoji: 'üéÆ', name: 'play'}
            ]
        },
        {
            name: 'Adjectives (Feeling)',
            items: [
                {emoji: 'üòä', name: 'happy'},
                {emoji: 'üò¢', name: 'sad'},
                {emoji: 'üò†', name: 'angry'},
                {emoji: 'üò¥', name: 'sleepy'},
                {emoji: 'üò®', name: 'scared'},
                {emoji: 'üò´', name: 'tired'},
                {emoji: 'üòã', name: 'hungry'},
                {emoji: 'ü•µ', name: 'hot'},
                {emoji: 'ü•∂', name: 'cold'},
                {emoji: 'ü§©', name: 'excited'}
            ]
        },
        {
            name: 'Adjectives (Describing)',
            items: [
                {emoji: 'üêò', name: 'big'},
                {emoji: 'üêú', name: 'small'},
                {emoji: 'üêá', name: 'fast'},
                {emoji: 'üê¢', name: 'slow'},
                {emoji: 'üÜï', name: 'new'},
                {emoji: 'üèöÔ∏è', name: 'old'},
                {emoji: 'üß¥', name: 'clean'},
                {emoji: 'üí©', name: 'dirty'},
                {emoji: 'üç¨', name: 'sweet'},
                {emoji: 'üå∂Ô∏è', name: 'spicy'}
            ]
        },
        {
            name: 'School Objects',
            items: [
                {emoji: '‚úèÔ∏è', name: 'a pencil'},
                {emoji: 'üñäÔ∏è', name: 'a pen'},
                {emoji: 'üìï', name: 'a book'},
                {emoji: 'üìì', name: 'a notebook'},
                {emoji: 'üìè', name: 'a ruler'},
                {emoji: 'üß¥', name: 'glue'},
                {emoji: 'üéí', name: 'a bag'},
                {emoji: 'üíª', name: 'a computer'},
                {emoji: 'üè´', name: 'a school'},
                {emoji: 'üë®‚Äçüè´', name: 'a teacher'}
            ]
        },
        {
            name: 'Prepositions & Logic',
            items: [
                {emoji: '‚¨ÜÔ∏è', name: 'up'},
                {emoji: '‚¨áÔ∏è', name: 'down'},
                {emoji: 'üì•', name: 'in'},
                {emoji: 'üì§', name: 'out'},
                {emoji: 'üîõ', name: 'on'},
                {emoji: 'üèÅ', name: 'start'},
                {emoji: 'üîö', name: 'end'},
                {emoji: 'üö´', name: 'no'},
                {emoji: '‚≠ï', name: 'yes'},
                {emoji: 'ü§ù', name: 'with'}
            ]
        },
        {
            name: 'Town & Vehicles',
            items: [
                {emoji: 'üöó', name: 'a car'},
                {emoji: 'üöå', name: 'a bus'},
                {emoji: 'üö≤', name: 'a bike'},
                {emoji: 'üöï', name: 'a taxi'},
                {emoji: 'üè†', name: 'a house'},
                {emoji: 'üèûÔ∏è', name: 'a park'},
                {emoji: 'üè•', name: 'a hospital'},
                {emoji: 'üè™', name: 'a store'},
                {emoji: 'üõ§Ô∏è', name: 'a station'},
                {emoji: '‚úàÔ∏è', name: 'a plane'}
            ]
        },
        {
            name: 'Clothes',
            items: [
                {emoji: 'üëï', name: 'a t-shirt'},
                {emoji: 'üß¢', name: 'a cap'},
                {emoji: 'üß•', name: 'a coat'},
                {emoji: 'üëó', name: 'a dress'},
                {emoji: 'üëî', name: 'a shirt'},
                {emoji: 'üß£', name: 'a scarf'},
                {emoji: 'üß§', name: 'gloves'},
                {emoji: 'üß¶', name: 'socks'},
                {emoji: 'üëü', name: 'shoes'},
                {emoji: 'üë¢', name: 'boots'}
            ]
        }
    ];

    function updateFruitButtonState() {
        if (fruitGameEnabled) {
            fruitToggleBtn.innerHTML = 'üçè';
            fruitToggleBtn.style.color = 'var(--success)';
            fruitToggleBtn.setAttribute('aria-pressed', 'true');
        } else {
            fruitToggleBtn.innerHTML = 'üçé';
            fruitToggleBtn.style.color = 'var(--warning)';
            fruitToggleBtn.setAttribute('aria-pressed', 'false');
        }

        fruitToggleBtn.classList.toggle('on', fruitGameEnabled);
        fruitToggleBtn.title = fruitGameEnabled ? 'Fruit Game is ON' : 'Fruit Game is OFF';

        if (fruitGameEnabled) {
            fruitToggleBtn.style.boxShadow = '0 0 10px var(--success)';
            fruitToggleBtn.style.border = '2px solid var(--success)';
        } else {
            fruitToggleBtn.style.boxShadow = 'none';
            fruitToggleBtn.style.border = '2px solid var(--warning)';
        }
    }

    function toggleFruitGame() {
        if (!readingModeContainer || readingModeContainer.style.display !== 'flex') {
            return;
        }

        fruitGameEnabled = !fruitGameEnabled;
        updateFruitButtonState();

        if (fruitGameEnabled) {
            playSound('activate');
            if (navigator.vibrate) navigator.vibrate(50);
        } else {
            if (fruitGameActive) {
                hideFruitGame();
            }
        }

        localStorage.setItem('fruitGameEnabled', fruitGameEnabled);
        logger.log('Fruit game is now', fruitGameEnabled ? 'ON' : 'OFF');
    }

    function showFruitGame() {
        if (!fruitGameEnabled || fruitGameActive) {
            logger.log('Fruit game not shown - enabled:', fruitGameEnabled, 'active:', fruitGameActive);
            return;
        }

        stopSpeech();
        fruitGameActive = true;

        const gameContainer = document.createElement('div');
        gameContainer.className = 'fruit-game-container';
        gameContainer.innerHTML = `
            <div class="fruit-game">
                <h2>Fruit Machine!</h2>
                <div class="fruit-reels">
                    <div class="reel-container">
                        <div class="fruit-reel" id="reel1">üçé</div>
                        <div class="fruit-name" id="name1"></div>
                    </div>
                    <div class="reel-container">
                        <div class="fruit-reel" id="reel2">üçä</div>
                        <div class="fruit-name" id="name2"></div>
                    </div>
                    <div class="reel-container">
                        <div class="fruit-reel" id="reel3">üçá</div>
                        <div class="fruit-name" id="name3"></div>
                    </div>
                </div>
                <div id="fruitResult"></div>
                <button id="exitFruitGame" class="btn">Exit Game</button>
            </div>
        `;

        document.body.appendChild(gameContainer);
        spinReels();
        document.getElementById('exitFruitGame').addEventListener('click', hideFruitGame);
    }

    function hideFruitGame() {
        const game = document.querySelector('.fruit-game-container');
        if (game && game.parentNode) {
            game.parentNode.removeChild(game);
        }

        fruitGameActive = false;

        if (window.AudioContext) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.close();
        }

        closeTranslationPopupHandler();

        if (!readingModeContainer || readingModeContainer.style.display !== 'flex') {
            return;
        }

        setTimeout(() => {
            if (shouldAdvanceAfterGame) {
                const isLastPage = currentSentenceIndex >= sentences.length - 1;
                currentSentenceIndex = isLastPage ? 0 : currentSentenceIndex + 1;
                shouldAdvanceAfterGame = false;
            }
            displayCurrentSentence();
        }, 500);
    }

    function spinReels() {
        const currentCategory = categories[Math.floor(Math.random() * categories.length)];
        const items = currentCategory.items;
        const reels = [
            document.getElementById('reel1'),
            document.getElementById('reel2'),
            document.getElementById('reel3')
        ];
        const resultDisplay = document.getElementById('fruitResult');

        resultDisplay.textContent = '';
        resultDisplay.style.color = '';
        playSound('spin');

        const shouldMatch = Math.random() < 0.33;
        let matchingItem = '';

        if (shouldMatch) {
            matchingItem = items[Math.floor(Math.random() * items.length)];
            matchingItem = items.find(item => item.emoji === matchingItem.emoji) || matchingItem;
        }

        spinReel(reels[0], 0, items, matchingItem, shouldMatch, () => {
            playSound('reelStop');
            spinReel(reels[1], 300, items, matchingItem, shouldMatch, () => {
                playSound('reelStop');
                spinReel(reels[2], 300, items, matchingItem, shouldMatch, () => {
                    playSound('reelStop');

                    setTimeout(() => {
                        if (shouldMatch && reels[0].textContent === reels[1].textContent &&
                            reels[1].textContent === reels[2].textContent) {
                            playSound('win');
                            playSound('coin');
                            resultDisplay.textContent = 'üéâ WINNER! üéâ';
                            resultDisplay.style.color = 'var(--success)';
                            resultDisplay.style.fontWeight = 'bold';

                            reels.forEach(reel => {
                                reel.style.transform = 'scale(1.2)';
                                reel.style.transition = 'all 0.3s';
                                reel.style.boxShadow = '0 0 20px gold';
                            });

                            setTimeout(() => {
                                createConfetti();
                            }, 500);

                            setTimeout(hideFruitGame, 3000);
                        } else {
                            playSound('lose');
                            resultDisplay.textContent = 'Try again!';
                            resultDisplay.style.color = 'var(--warning)';

                            reels.forEach(reel => {
                                reel.style.animation = 'shake 0.5s';
                            });

                            setTimeout(hideFruitGame, 2000);
                        }
                    }, 300);
                });
            });
        });
    }

    function spinReel(reel, delay, items, matchingItem, shouldMatch, callback) {
        const reelNumber = reel.id.replace('reel', '');
        const nameElement = document.getElementById(`name${reelNumber}`);

        setTimeout(() => {
            let spins = 0;
            const spinInterval = setInterval(() => {
                if (spins < 10) {
                    const randomItem = items[Math.floor(Math.random() * items.length)];
                    reel.textContent = randomItem.emoji;
                    nameElement.textContent = '';
                }
                else if (spins < 15) {
                    if (spins % 2 === 0) {
                        const randomItem = items[Math.floor(Math.random() * items.length)];
                        reel.textContent = randomItem.emoji;
                        nameElement.textContent = '';
                    }
                }
                else {
                    clearInterval(spinInterval);
                    let finalItem;
                    if (shouldMatch) {
                        finalItem = matchingItem;
                    } else {
                        finalItem = items[Math.floor(Math.random() * items.length)];
                    }
                    reel.textContent = finalItem.emoji;
                    nameElement.textContent = finalItem.name;

                    if (window.speechSynthesis) {
                        const utterance = new SpeechSynthesisUtterance(finalItem.name);
                        utterance.rate = 0.9;
                        window.speechSynthesis.speak(utterance);
                    }

                    if (callback) callback();
                }
                spins++;
            }, 100);
        }, delay);
    }

    function createConfetti() {
        const container = document.querySelector('.fruit-game-container');
        if (!container) return;

        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.style.position = 'absolute';
            confetti.style.width = '10px';
            confetti.style.height = '10px';
            confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
            confetti.style.borderRadius = '50%';
            confetti.style.left = `${Math.random() * 100}%`;
            confetti.style.top = '-10px';
            confetti.style.opacity = '0.8';
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            confetti.style.animation = `confetti-fall ${2 + Math.random() * 3}s linear forwards`;

            container.appendChild(confetti);

            setTimeout(() => {
                confetti.remove();
            }, 5000);
        }
    }

    function playSound(type) {
        if (!window.AudioContext) return;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let oscillator = audioCtx.createOscillator();
        let gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        switch(type) {
            case 'spin':
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.8);
                break;

            case 'reelStop':
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
                break;

            case 'win':
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
                oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(1046.5, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
                break;

            case 'lose':
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(349.23, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(261.63, audioCtx.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.6);
                break;

            case 'activate':
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(784, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
                break;

            case 'coin':
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(988, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1318, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
                break;
        }
    }

    // ====================
    // DATA LOADING
    // ====================
    function loadExternalData() {
        return Promise.all([
            loadVocabData(),
            loadLessonsData()
        ]);
    }

    function loadVocabData() {
        return new Promise((resolve, reject) => {
            if (typeof vocab !== 'undefined') {
                logger.log('Vocabulary data loaded');
                resolve();
            } else {
                const error = 'Vocabulary data not found. Please ensure vocab.js is loaded.';
                logger.error(error);
                reject(error);
            }
        });
    }
function loadLessonsData() {
    return new Promise((resolve, reject) => {
        try {
            // Standard format for all classes
            const classData = {
                'Bronze': {
                    stories: typeof bronzeStories !== 'undefined' ? bronzeStories : []
                },
                'Silver': {
                    stories: typeof silverStories !== 'undefined' ? silverStories : []
                },
                'Gold': {
                    stories: typeof goldStories !== 'undefined' ? goldStories : []
                },
                'Adult': adult,
                'X': x,
                'C': c,
                'Eiken1': eiken1,
                'EikenPre1': eikenpre1,
                'Eiken2': eiken2,
                'EikenPre2': eikenpre2,
                'EikenPre2Plus': eikenpre2plus,
                'Eiken3': {
                    stories: window.eiken3 ? window.eiken3.map(story => ({
                        title: story.title,
                        content: story.content
                    })) : [],
                    questions: window.eiken3questions ? window.eiken3questions.questions : []
                },
            'Eiken4': {
    stories: Array.isArray(eiken4) ?
        eiken4.map(story => ({
            title: story.title,
            content: story.content
        })) :
        Object.values(eiken4).map(story => ({
            title: story.title,
            content: story.content
        }))
},
                'Eiken6': {
    stories: typeof eiken6 !== 'undefined' ? eiken6.map(story => ({
        title: story.title,
        content: story.title + '\n' + story.content
    })) : []
},
                'Eiken7': {
    stories: typeof eiken7 !== 'undefined' ? eiken7.map(story => ({
        title: story.title,
        content: story.title + '\n' + story.content
    })) : []
},
'Eiken5': {
    stories: typeof eiken5 !== 'undefined' ? eiken5.map(story => ({
        title: story.title,
        content: story.title + '\n' + story.content
    })) : [],
    questions: typeof qa5 !== 'undefined' ? qa5.questions : []
},
                'HighSchool': {
                    stories: [
                        {
                            title: 'Getting to Know You',
                            content: typeof gettingtoknow !== 'undefined' ? gettingtoknow.questions : []
                        },
                        {
                            title: 'Easy Questions',
                            content: typeof easyquestions !== 'undefined' ? easyquestions.questions : []
                        },
                        {
                            title: 'Would You Rather',
                            content: typeof wouldyourather !== 'undefined' ? wouldyourather.questions : []
                        }
                    ]
                },
                'Conversation': {
                    stories: [
                        {
                            title: 'Getting to Know You',
                            content: typeof gettingtoknow !== 'undefined' ? gettingtoknow.questions : []
                        },
                        {
                            title: 'Easy Questions',
                            content: typeof easyquestions !== 'undefined' ? easyquestions.questions : []
                        },
                        {
                            title: 'Would You Rather',
                            content: typeof wouldyourather !== 'undefined' ? wouldyourather.questions : []
                        }
                    ]
                },
                'VocabEiken5': {
                    stories: typeof vocabularyCategories !== 'undefined' ? Object.entries(vocabularyCategories).map(([category, words]) => ({
                        title: category,
                        content: words.map((word, i) =>
                            `${i+1}. ${word.emoji || ''} ${word.english} - ${word.japanese}`
                        ).join('\n')
                    })) : []
                }
            };

// Process each class to ensure consistent structure
            Object.entries(classData).forEach(([className, data]) => {
                if (!data) return; // Skip if data not loaded

                if (Array.isArray(data)) {
                    // UPDATED LOGIC HERE:
                    // Check if the items inside the array are Objects with a 'title' property
                    lessonsData[className] = {
                        stories: data.map((item, i) => ({
                            // If item.title exists, use it. If not, make a generic "Story X" title.
                            title: item.title ? item.title : `Story ${i+1}`,
                            // If item.content exists, use it. If item is just a string, use item itself.
                            content: item.content ? item.content : item
                        }))
                    };
                } else if (data.stories || data.questions) {
                    // For classes that already have the right structure
                    lessonsData[className] = data;
                } else {
                    // For simple objects with content
                    lessonsData[className] = {
                        stories: Object.entries(data).map(([key, content]) => ({
                            title: key.replace(/_/g, ' '),
                            content: content
                        }))
                    };
                }

                logger.log(`${className} loaded with`,
                    lessonsData[className].stories?.length || 0, 'stories and',
                    lessonsData[className].questions ? 'questions' : 'no questions');
            });
            
            // Create additional organized classes for Q&A
            if (lessonsData['Adult']?.questions) {
                lessonsData['Calendar'] = { questions: lessonsData['Adult'].questions };
            }
            if (typeof gettingtoknow !== 'undefined') {
                lessonsData['ConversationQA'] = {
                    stories: [{
                        title: 'Getting to Know You',
                        content: gettingtoknow.questions
                    }, {
                        title: 'Easy Questions',
                        content: easyquestions?.questions || ''
                    }, {
                        title: 'Would You Rather',
                        content: wouldyourather?.questions || ''
                    }]
                };
            }
            if (window.eiken3questions) {
                lessonsData['Eiken3Questions'] = {
                    stories: [{ title: 'Eiken 3 Questions', content: eiken3questions.questions }]
                };
            }
            if (typeof qa5 !== 'undefined') {
                lessonsData['Eiken5Questions'] = {
                    stories: [{ title: 'Eiken 5 Questions', content: qa5.questions }]
                };
            }
            // Add placeholders for other Eiken Q&A sections (coming soon)
            lessonsData['Eiken7Questions'] = {
                stories: [{ title: 'Eiken 7 Questions *', content: 'Q & A content coming soon!\nQ & A„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØËøëÊó•ÂÖ¨Èñã‰∫àÂÆö„Åß„ÅôÔºÅ' }]
            };
            lessonsData['Eiken6Questions'] = {
                stories: [{ title: 'Eiken 6 Questions *', content: 'Q & A content coming soon!\nQ & A„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØËøëÊó•ÂÖ¨Èñã‰∫àÂÆö„Åß„ÅôÔºÅ' }]
            };
            lessonsData['Eiken2Questions'] = {
                stories: [{ title: 'Eiken 2 Questions *', content: 'Q & A content coming soon!\nQ & A„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØËøëÊó•ÂÖ¨Èñã‰∫àÂÆö„Åß„ÅôÔºÅ' }]
            };
            lessonsData['Eiken1Questions'] = {
                stories: [{ title: 'Eiken 1 Questions *', content: 'Q & A content coming soon!\nQ & A„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØËøëÊó•ÂÖ¨Èñã‰∫àÂÆö„Åß„ÅôÔºÅ' }]
            };
            lessonsData['EikenPre2Questions'] = {
                stories: [{ title: 'Eiken Pre-2 Questions *', content: 'Q & A content coming soon!\nQ & A„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØËøëÊó•ÂÖ¨Èñã‰∫àÂÆö„Åß„ÅôÔºÅ' }]
            };
            lessonsData['EikenPre1Questions'] = {
                stories: [{ title: 'Eiken Pre-1 Questions *', content: 'Q & A content coming soon!\nQ & A„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØËøëÊó•ÂÖ¨Èñã‰∫àÂÆö„Åß„ÅôÔºÅ' }]
            };

            if (Object.keys(lessonsData).length > 0) {
                resolve();
            } else {
                reject('No lesson data found');
            }
        } catch (e) {
            logger.error('Error loading lesson data:', e);
            reject(e);
        }
    });
}

    // ====================
    // UTILITY FUNCTIONS
    // ====================
    function toggleNightMode() {
        isNightMode = !isNightMode;
        document.body.classList.toggle('dark-mode', isNightMode);
        const toggle = document.getElementById('nightModeToggle');
        toggle.textContent = isNightMode ? '‚òÄÔ∏è' : 'üåô';
        toggle.setAttribute('aria-checked', isNightMode);
        localStorage.setItem('nightMode', isNightMode);
    }

    function handleRemoteInput(e) {
        const activeElement = document.activeElement;

        switch(e.key) {
            case 'ArrowUp':
                navigateFocus('up');
                e.preventDefault();
                break;
            case 'ArrowDown':
                navigateFocus('down');
                e.preventDefault();
                break;
            case 'ArrowLeft':
                if (activeElement === prevSentenceBtn) {
                    showPreviousSentence();
                } else {
                    navigateFocus('left');
                }
                e.preventDefault();
                break;
            case 'ArrowRight':
                if (activeElement === nextSentenceBtn) {
                    showNextSentence();
                } else {
                    navigateFocus('right');
                }
                e.preventDefault();
                break;
            case 'Enter':
                if (activeElement) {
                    activeElement.click();
                }
                break;
            case 'Backspace':
                exitReadingMode();
                break;
        }
    }

    function navigateFocus(direction) {
        const focusable = Array.from(document.querySelectorAll('button, select, [tabindex="0"]'));
        const currentIndex = focusable.indexOf(document.activeElement);

        if (currentIndex === -1) {
            if (focusable.length > 0) focusable[0].focus();
            return;
        }

        let nextIndex = currentIndex;

        if (direction === 'up' || direction === 'left') {
            nextIndex = Math.max(0, currentIndex - 1);
        } else {
            nextIndex = Math.min(focusable.length - 1, currentIndex + 1);
        }

        focusable[nextIndex].focus();
    }

    // ====================
    // INITIALIZATION
    // ====================
    window.addEventListener('DOMContentLoaded', function() {
        const savedNightMode = localStorage.getItem('nightMode') === 'true';
        if (savedNightMode) {
            isNightMode = true;
            document.body.classList.add('dark-mode');
            document.getElementById('nightModeToggle').textContent = '‚òÄÔ∏è';
        }

        init();
        setTimeout(listVoices, 1000);
    });
</script>
</body>
</html>








